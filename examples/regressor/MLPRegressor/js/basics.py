# -*- coding: utf-8 -*-

from sklearn.neural_network import MLPRegressor
from sklearn.datasets import load_diabetes
from sklearn_porter import Porter


samples = load_diabetes()
X, y = samples.data, samples.target

mdl = MLPRegressor(
    activation='relu', hidden_layer_sizes=30, max_iter=500, alpha=1e-4,
    solver='sgd', tol=1e-4, random_state=1, learning_rate_init=.1)
mdl.fit(X, y)

output = Porter(mdl, language='js').export()
print(output)

"""
// Array.prototype.fill polyfill:
[].fill||(Array.prototype.fill=function(a){for(var b=Object(this),c=parseInt(b.length,10),d=arguments[1],e=parseInt(d,10)||0,f=0>e?Math.max(c+e,0):Math.min(e,c),g=arguments[2],h=void 0===g?c:parseInt(g)||0,i=0>h?Math.max(c+h,0):Math.min(h,c);i>f;f++)b[f]=a;return b});

var Brain = (function() {
    var instance;

    function init() {

        // Activation function (relu):
        var compAct = function(v) {
            for (var i = 0, l = v.length; i < l; i++) {
                v[i] = Math.max(0, v[i]);
            }
            return v;
        };

        // Model data:
        const COEFFICIENTS = [[[-0.2319340173034137, 9.7696349809756864, -0.51829197892583256, 1.3770988439175322, -0.2736049266669035, 0.036915805872824392, -0.24300688851419572, -0.11962080853838027, 2.7063277104158829, 0.030065468565078319, 10.356283153433806, 10.771408485619897, -0.228916260559382, 0.29287054126544548, -0.36606154085361509, 0.8421762930779243, 5.8294603332356516, 0.045458157094643424, -0.27853799323563749, -0.45337224729351655, 0.11079678111893151, 3.62612480907746, -0.14451214535647994, 0.14896331966670193, 0.95420509750491822, 0.18744888345365507, -0.32140365590470055, -0.38242688626265464, 1.1943665144469617, 4.4502258251752602], [-0.31155376112010547, 5.3398998028469116, 0.35430322105723627, 0.89496264019390148, 0.14861825668633027, 0.14850441998515407, 0.14445413614869493, 0.25918403177940236, 1.1100692655071864, 0.19374906804525499, 6.2159440371329735, 6.1263686364833294, -0.17005692066444431, 0.22406105973091495, -0.30732096176996326, 0.25151069293752498, 3.6194194729068148, -0.15985598720931629, -0.16437843240275474, -0.28715504955255716, 0.67513481258000008, 1.9356321521420288, -0.22335819939675594, -0.18159563712939689, 0.31932765179784151, -0.22610520469072778, 0.057407728786411552, -0.27369481376108123, 0.88571670110979661, 2.3918733103172523], [-1.1139693220578886, 25.109915984202907, -0.47965357377780621, 3.9275649773818566, -0.34858316858158306, -0.14440429486824666, 0.12686700422961469, 0.011532349179925655, 7.9441203858414351, 0.067041133577510514, 27.736998326305756, 27.773192103110308, -0.27939820082427907, 0.23808966326419548, -0.079254319562917702, 1.1130006104206844, 15.839999334803101, -0.11791282486458982, 0.194266302825197, -0.88026712181320821, 0.45844036835063429, 8.8077375691170428, 0.19436725050697634, -0.11703566170722933, 1.3405023148589443, 0.031372409413316524, -0.055696908201751237, 0.23793338008849144, 4.4296567508913771, 11.39623092423216], [-0.87744359468625277, 15.364515553544321, -0.49158536224445259, 2.4377504679278186, -0.07115256189841819, -0.058686359393546959, 0.3124372672418026, 0.057068384224317821, 4.2066642600404069, 0.09073449398700309, 16.249151474976053, 16.801578450654546, 0.29893112732681038, -0.11055158694082332, 0.3164305563844324, 1.0871353178111536, 8.8889043165826269, 0.33262024699658294, 0.14785904636590663, -0.37299571094599093, 0.21118417650788396, 4.9560896514221806, 0.33506645083057579, 0.15244534088827133, 0.49319574076774031, 0.017772795842345767, 0.19663958752798189, 0.23992397903535112, 2.8499552809532775, 6.5568458483180283], [-0.61374215376294705, 7.0861521188517385, -0.55447891697349772, 0.9664403250760325, 0.27885934382678584, -0.42006133200341267, 0.040913219014891526, 0.26491973903920119, 1.9568239335459661, -0.17103309507628017, 8.1859274272128637, 8.6702894172924374, 0.047270904821454018, -0.37283133580536271, 0.23285478292256301, 0.11376433166552144, 4.8294978569198266, -0.086857443506328944, 0.28158103665809503, -0.12528887107708933, 0.03153481461229897, 2.2988231751346024, -0.34086538220534918, -0.29328810680990042, 0.017522406180946703, -0.29093861882354521, -0.21245160030895177, 0.12832613410361565, 1.1598176130649647, 2.9717899164895902], [-0.44715934967233567, 7.177889386613348, -0.037672647159778132, 0.84111909920779693, -0.19183588553215578, -0.17709786333356187, -0.23590483838144261, 0.063016488461164172, 2.3416604071158402, 0.26863595550724728, 7.1957271580507127, 7.5401036962922916, 0.092911600442346934, 0.2548118781214746, -0.26583193564507873, -0.17975902185006365, 3.8512955364652846, -0.010576382800438508, 0.082357394792756958, -0.098079157799536992, 0.16528506907809645, 2.6943023713510024, 0.061766592270293512, -0.092836553596243973, 0.34300133848501557, 0.18707830866189734, 0.13107919480948454, -0.19960045157191286, 0.56140542572890872, 2.8476606015531889], [0.40580075574768681, -12.667511799038341, 0.43452575114711944, -2.3148824955187766, -0.18564773812726143, 0.11419589053539378, -0.23745021768503038, 0.10801930759531074, -3.6775487393637567, 0.32903465497977874, -13.712633739084731, -14.15598127543675, 0.18207014349440495, 0.21081526309322535, 0.31587342440311811, -0.37930396935400035, -8.0284480810681167, -0.2057496220243239, 0.090450577867040347, 0.74757909253579691, -0.58759174417481597, -4.2231088233880731, 0.32190754748362527, 0.10964998767246452, -0.93412473205777191, 0.038880854681643165, 0.080793596518640057, 0.084636595002779938, -1.5938592810705299, -5.1603928705372288], [-0.40045941814817027, 12.603967104564354, -0.5020100170998093, 1.6434747198265309, -0.28264913018027404, -0.12588743250903517, -0.37060255829236532, 0.34697494905913295, 3.8990743759453084, -0.375641639193456, 13.068287978490556, 13.479005934422734, -0.28581108245203335, 0.2397157544092034, -0.12025909463829627, 1.0102423343406757, 7.5964107543784483, 0.29342399383202949, 0.26701377375910085, -0.10374573865665455, 0.61836038944444793, 4.2427613349422018, 0.23128315953693401, -0.16597128255866966, 0.74428887041028768, 0.066841124808098049, -0.37524329258337757, 0.024069911131378307, 1.7712727612826318, 5.6557396897121599], [-0.86577286465575909, 18.768397333745391, -0.50479485440354899, 2.666342737393129, 0.22301534507769599, -0.11624366162721646, -0.3455191968618378, -0.061813917807021945, 5.8165722928816699, 0.32422765387682501, 19.760902513083071, 21.007895652466789, -0.095594613060487554, 0.36696863981219618, 0.081107767640128739, 1.4642939259551759, 11.450260494809561, 0.099201311316180416, -0.16608171006163983, -0.87900187510215533, 0.4060665303668437, 6.7215611696353372, 0.19757369381522866, 0.15340507464546932, 1.5394455440687587, -0.17356948578997797, 0.13228431377683325, -0.14754010447910187, 3.0279473694019288, 8.3626443251195326], [-0.48871872636590924, 19.153753369353829, -0.22805508120712026, 3.0166749550603185, 0.36698299961966535, 0.08662377128387394, -0.23347243854361874, -0.056773671352878481, 5.5298301242238708, 0.23053588443040807, 21.257705446986915, 21.71313207727211, 0.12603449335693204, -0.17798499672490598, -0.19180416237328299, 1.5567681809192746, 11.878728654550093, 0.23403861262373535, 0.056145919818109888, -0.35942525651202811, 0.48835231697604164, 6.801133445143563, 0.053333898591469385, -0.026559384599342137, 1.0359915855962489, -0.27796591631448203, -0.094553723882327134, -0.3880831592909868, 3.6080837836053257, 8.1921051456646286]], [[33.447936865400585], [-1660.3764946519527], [21.265892202084643], [-122.08111729806504], [0.2510116389982513], [-0.21226070074411099], [-0.15453095203801565], [0.32810781665211225], [-2232.2834867464671], [0.033821137333622638], [-2413.2071553520668], [-2950.0984550659623], [0.28718225054221325], [0.31156093726953332], [-0.35303707869952333], [-502.75269440016103], [-1337.7324353153367], [0.0969930329539469], [0.26361011187589828], [41.952518110106119], [-2.3396943267217201], [-1511.1021315706287], [-0.21142425475772123], [-0.2137374075824118], [-555.78218064192743], [0.68948093588684667], [0.26094723659140134], [14.999877552728096], [-1629.2506633868595], [-3196.9708836660661]]];
        const INTERCEPTS = [[-46.583690966353373, -2241.7246565368969, -36.469491911994986, -363.38263860892874, -0.26261039582035528, -9.2467240647122697, -0.11992921348066127, -0.21298313285170783, -584.13069604997668, -0.14541515843225822, -2410.2674947416658, -2440.0701887437431, -0.18813536065599931, -0.30140230241656107, -0.23783004511099995, -110.13547411246624, -1364.3359494342617, -0.22603161607469066, -0.19517236644162575, -61.040152562948975, -25.571011513068932, -726.33043050589504, -0.20630132145150193, -0.30831483509783675, -129.63799717507473, -5.9482822866852985, -0.26903938761855628, -6.9999939760549292, -307.06093311198515, -877.45114572659782], [151.51211299009748]];
        
        return {
            predict: function(atts) {
                if (atts.length != 10) { return -1; };
                var layers = [atts, new Array(30).fill(.0), new Array(1).fill(.0)];
        
                for (var i = 0; i < layers.length - 1; i++) {
                    for (var j = 0; j < layers[i + 1].length; j++) {
                        for (var l = 0; l < layers[i].length; l++) {
                            layers[i + 1][j] += layers[i][l] * COEFFICIENTS[i][l][j];
                        }
                        layers[i + 1][j] += INTERCEPTS[i][j];
                    }
                    if ((i + 1) < (layers.length - 1)) {
                        layers[i + 1] = compAct(layers[i + 1]);
                    }
                }
                if (layers[layers.length - 1].length > 1) {
                    return layers[layers.length - 1];
                }
                return layers[layers.length - 1][0];
            }
        };

    };

    return {
        getInstance: function() {
            if (!instance) {
                instance = init();
            }
            return instance;
        }
    };

})();

if (typeof process !== 'undefined' && typeof process.argv !== 'undefined') {
    if (process.argv.length - 2 == 10) {
        const features = process.argv.slice(2);
        var brain = Brain.getInstance();
        var prediction = brain.predict(features);
        console.log(prediction);
    }
}

// Web Worker (brain.js):
var onmessage = function(e) {
    if (e.data.length == 10) {
        const features = e.data;
        var brain = Brain.getInstance();
        var prediction = brain.predict(features);
        postMessage(prediction);
    }
};

// Web Worker (main.js):
// if (typeof window !== 'undefined' && window.Worker) {
//     var worker = new Worker('brain.js');
//     worker.onmessage = function(e) {
//         console.log('Prediction: ' + e.data);
//     };
//     worker.postMessage([/* feature vector */]);
//     worker.postMessage([/* feature vector */]);
// }
"""
